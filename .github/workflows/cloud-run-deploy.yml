name: Deploy to Cloud Run

env:
  SERVICE_NAME: cummins-demo-ready
  REGION: us-central1

on:
  push:
    branches:
      - master

jobs:
  dockerize-and-deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Google Cloud Auth
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Set up Cloud SDK
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: Configure Docker
        run: gcloud auth configure-docker

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.DOCKER_IMAGE_NAME }}:latest
            gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.DOCKER_IMAGE_NAME }}:${{ github.sha }}
          build-args: |
            NEXT_PUBLIC_FIREBASE_API_KEY=${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}
            NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}
            NEXT_PUBLIC_FIREBASE_PROJECT_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}
            NEXT_PUBLIC_GOOGLE_MAPS_API_KEY=${{ secrets.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to Cloud Run
        run: |
          COMMIT_SHA=$(git rev-parse --short HEAD)
          gcloud run deploy $SERVICE_NAME \
            --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.DOCKER_IMAGE_NAME }}:latest \
            --platform managed \
            --region $REGION \
            --allow-unauthenticated \
            --memory=512Mi \
            --cpu=1 \
            --max-instances=10 \
            --min-instances=0 \
            --concurrency=80 \
            --timeout=300s \
            --revision-suffix=$COMMIT_SHA \
            --tag=commit-$COMMIT_SHA \
            --set-env-vars "NEXT_PUBLIC_FIREBASE_API_KEY=${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }},NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }},NEXT_PUBLIC_FIREBASE_PROJECT_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }},NEXT_PUBLIC_GOOGLE_MAPS_API_KEY=${{ secrets.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY }},GCP_PROJECT_ID=${{ secrets.GCP_PROJECT_ID }},BIGQUERY_DATASET=${{ secrets.BIGQUERY_DATASET }},BIGQUERY_DATASET_2=${{ secrets.BIGQUERY_DATASET_2 }},BIGQUERY_LOCATION_2=${{ secrets.BIGQUERY_LOCATION_2 }},BIGQUERY_TABLE_1=${{ secrets.BIGQUERY_TABLE_1 }},BIGQUERY_TABLE_2=${{ secrets.BIGQUERY_TABLE_2 }},BIGQUERY_TABLE_3=${{ secrets.BIGQUERY_TABLE_3 }},BIGQUERY_TABLE_PP=${{ secrets.BIGQUERY_TABLE_PP }}, BIGQUERY_TABLE_4=${{ secrets.BIGQUERY_TABLE_4 }}, BIGQUERY_TABLE_5=${{ secrets.BIGQUERY_TABLE_5 }}, BIGQUERY_TABLE_7=${{ secrets.BIGQUERY_TABLE_7 }}, BIGQUERY_TABLE_8=${{ secrets.BIGQUERY_TABLE_8 }}, BIGQUERY_TABLE_9=${{ secrets.BIGQUERY_TABLE_9 }}, BIGQUERY_TABLE_10=${{ secrets.BIGQUERY_TABLE_10 }}, BIGQUERY_TABLE_11=${{ secrets.BIGQUERY_TABLE_11 }}, BIGQUERY_TABLE_12=${{ secrets.BIGQUERY_TABLE_12 }}, BIGQUERY_TABLE_13=${{ secrets.BIGQUERY_TABLE_13 }}, BIGQUERY_TABLE_14=${{ secrets.BIGQUERY_TABLE_14 }}, BIGQUERY_TABLE_15=${{ secrets.BIGQUERY_TABLE_15 }}, BIGQUERY_TABLE_16=${{ secrets.BIGQUERY_TABLE_16 }}, BIGQUERY_TABLE_17=${{ secrets.BIGQUERY_TABLE_17 }} ,BIGQUERY_TABLE_18=${{ secrets.BIGQUERY_TABLE_18 }}"

      - name: Tag latest revision
        run: |
          COMMIT_SHA=$(git rev-parse --short HEAD)
          gcloud run services update-traffic $SERVICE_NAME \
            --region $REGION \
            --update-tags=latest=$SERVICE_NAME-$COMMIT_SHA

      - name: Clean up old revisions
        run: |
          echo "Cleaning up old revisions (keeping last 10)..."
          gcloud run revisions list \
            --service=$SERVICE_NAME \
            --region=$REGION \
            --format="value(name)" \
            --sort-by="~metadata.creationTimestamp" \
            | tail -n +11 \
            | xargs -r -I {} gcloud run revisions delete {} --region=$REGION --quiet || true

      - name: Output deployment info
        run: |
          echo "=========================================="
          echo "Deployment successful!"
          echo "=========================================="
          echo "Service URL: $(gcloud run services describe $SERVICE_NAME --region=$REGION --format='value(status.url)')"
          echo "Commit: $(git rev-parse --short HEAD)"
          echo "Tagged URL: https://commit-$(git rev-parse --short HEAD)---$SERVICE_NAME-*.a.run.app"
          echo "Latest URL: https://latest---$SERVICE_NAME-*.a.run.app"
          echo "=========================================="
